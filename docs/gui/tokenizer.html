// --- SIDEBAR AND NAVIGATION FUNCTIONALITY ---
const DOM = {
    sidebar: document.getElementById('sidebar'),
    menuToggle: document.getElementById('menu-toggle'),
    closeMenuBtn: document.getElementById('close-menu'),
    backdrop: document.getElementById('backdrop'),
    sidebarToolLinks: document.querySelectorAll('.sidebar-tool-link')
};

// Detect if we're in an iframe
const isEmbedded = window.parent !== window;

// Apply iframe mode immediately
if (isEmbedded) {
    document.body.classList.add('iframe-mode');
    DOM.sidebar.style.display = 'none';
    DOM.menuToggle.style.display = 'none';
    DOM.closeMenuBtn.style.display = 'none';
    DOM.backdrop.style.display = 'none';
    // Hide sidebar and header for iframe mode
    DOM.sidebar.style.display = 'none';
    document.getElementById('mobile-header').style.display = 'none';
    document.getElementById('backdrop').style.display = 'none';
}

// Storage keys
const STORAGE_KEYS = {
    TOOL_URL: 'selectedToolUrl',
    TOOL_NAME: 'selectedToolName'
};

/* --- UI/VISUAL CONTROLS --- */
function toggleSidebar(forceClose = false) {
    // Don't toggle sidebar in iframe mode
    if (isEmbedded) return;
    
    const isOpen = DOM.sidebar.classList.contains('open');
    const shouldOpen = forceClose ? false : !isOpen;

    if (shouldOpen) {
        DOM.sidebar.classList.add('open');
        DOM.backdrop.style.display = 'block';
        document.body.style.overflow = 'hidden'; 
    } else {
        DOM.sidebar.classList.remove('open');
        DOM.backdrop.style.display = 'none';
        document.body.style.overflow = '';
    }
}

function updateActiveSidebarItem(activeTool) {
    if (isEmbedded) return; // Skip in iframe mode
    
    DOM.sidebarToolLinks.forEach(link => {
        link.classList.remove('active');
        const toolUrl = link.getAttribute('data-tool-url');
        if (toolUrl && toolUrl === activeTool) {
            link.classList.add('active');
        }
    });
}

function saveSelectedTool(toolUrl, toolName) {
    if (isEmbedded) return; // Skip in iframe mode
    localStorage.setItem(STORAGE_KEYS.TOOL_URL, toolUrl);
    localStorage.setItem(STORAGE_KEYS.TOOL_NAME, toolName);
}

function getSelectedTool() {
    if (isEmbedded) return { toolUrl: null, toolName: null };
    const toolUrl = localStorage.getItem(STORAGE_KEYS.TOOL_URL);
    const toolName = localStorage.getItem(STORAGE_KEYS.TOOL_NAME);
    return { toolUrl, toolName };
}

function clearSelectedTool() {
    if (isEmbedded) return; // Skip in iframe mode
    localStorage.removeItem(STORAGE_KEYS.TOOL_URL);
    localStorage.removeItem(STORAGE_KEYS.TOOL_NAME);
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    // Only initialize sidebar functionality if not in iframe
    if (!isEmbedded) {
        updateActiveSidebarItem('tokenizer.html');
        
        // Mobile Menu Toggles
        DOM.menuToggle.addEventListener('click', () => toggleSidebar());
        DOM.backdrop.addEventListener('click', () => toggleSidebar(true));
        DOM.closeMenuBtn.addEventListener('click', () => toggleSidebar(true));

        // Sidebar Navigation Handler
        const handleToolSwitch = (e) => {
            const link = e.target.closest('[data-tool-url]');
            if (link) {
                e.preventDefault();
                const relativeUrl = link.getAttribute('data-tool-url');
                const toolName = relativeUrl;
                
                // Save selection to localStorage
                saveSelectedTool(relativeUrl, toolName);
                
                // Close mobile sidebar if open
                if (window.innerWidth < 1024) {
                    toggleSidebar(true);
                }
                
                // In a standalone context, we would navigate to the tool
                // For now, just update the active state
                console.log('Would navigate to:', relativeUrl);
                updateActiveSidebarItem(relativeUrl);
            }
        };
        
        // Attach handler to sidebar links
        DOM.sidebarToolLinks.forEach(link => {
            link.addEventListener('click', handleToolSwitch);
        });
    }

    // Set initial overflow based on whether embedded
    if (isEmbedded) {
        document.body.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = 'auto';
    }
    
    document.body.classList.add('loading-active');
    contentWrapper.style.opacity = '0';
    loader.style.display = 'flex'; 
    loadingText.textContent = "Initializing search-query...";
    btnTokenize.disabled = true;

    // Add event listeners if buttons exist
    const copyBtn = document.getElementById('copy-json');
    const downloadBtn = document.getElementById('download-json');
    
    if (copyBtn) {
        copyBtn.addEventListener('click', copyJsonToClipboard);
    }
    
    if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadJson);
    }
    
    // When tokenize button is clicked
    btnTokenize.addEventListener('click', () => {
        setTimeout(debouncedSendHeight, 800);
    });

    // Initialize Highlight.js
    hljs.highlightAll();

    window.addEventListener('load', debouncedSendHeight);
    
    // Observe DOM changes
    const observer = new MutationObserver(debouncedSendHeight);
    observer.observe(document.body, { 
        attributes: true, 
        childList: true, 
        subtree: true 
    });
    
    // Also listen for details toggle (expand/collapse)
    document.querySelectorAll('details').forEach(details => {
        details.addEventListener('toggle', debouncedSendHeight);
    });
    
    // Listen for resize events
    window.addEventListener('resize', debouncedSendHeight);
    
    // Initial height calculation
    setTimeout(debouncedSendHeight, 100);
});
