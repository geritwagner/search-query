<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>search-query translator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Highlight.js for JSON coloring -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    html, body {
    height: auto;
    min-height: 100%;
  }
    /* --- CSS Variables (Ensure consistency with Host) --- */
    :root {
      --primary: #4f46e5;       /* Indigo */
      --primary-dark: #3f35c5;
      --bg-card: #ffffff;
      --border-color: #e5e7eb;  /* Gray-200 */
      --text-main: #1f2937;     /* Dark Gray */
      --text-secondary: #6b7280; /* Medium Gray */
    }
    #result, #messages {
      max-height: none !important; /* Remove the 400px limit if it exists */
    }
    
    /* --- Global Resets & Body Styles for IFRAME --- */
    * { box-sizing: border-box; margin: 0; padding: 0; line-height: 1.5; font-family: 'Inter', sans-serif; }
    html {
      height: auto !important;
      min-height: 100% !important;
    }
    /* Add to your CSS */
    body {
      background-color: var(--bg-card);
      color: var(--text-main);
      padding: 1.5rem; 
      overflow-x: hidden;
      overflow-y: auto;
      height: auto !important;
      min-height: 100% !important;
      margin: 0 !important;
      position: relative;
      /* ADD THIS: Extra bottom padding for iframe safety */
      padding-bottom: 10px !important;
    }    
    #content-wrapper {
      min-height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      
      /* ADD THIS: Extra padding at bottom */
      padding-bottom: 20px;
    }

    /* UTILITY CLASS FOR VIEWPORT LOCK */
    body.loading-active {
      height: 100vh;    /* Locks height */
    }
    
    /* --- Layout & Typography --- */
    header h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem; }
    header p { color: var(--text-secondary); margin-top: 0; font-size: 0.95rem; }
    
    /* --- Form Elements --- */
    label { display: block; margin-top: 1.25rem; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.875rem; }
    
    /* Query textarea with larger font size */
    #query {
      font-size: 1.1rem !important;
      line-height: 1.6;
      padding: 1rem;
      min-height: 120px;
      font-family: 'Courier New', monospace;
      width: 100%;
      
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.07);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    #query:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
      outline: none;
    }
    
    /* Narrower form elements */
    select { 
      display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); 
      border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.07); 
      transition: border-color 0.2s, box-shadow 0.2s; color: var(--text-main);
      max-width: 300px;
    }
    
    select:focus { 
      border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); outline: none; 
    }

    /* --- Button --- */
    #btn-translate {
      width: auto;
      min-width: 200px;
      padding: 0.75rem 2rem;
      border: none; 
      border-radius: 0.5rem; 
      font-weight: 600; 
      color: white; 
      background-color: var(--primary); 
      cursor: pointer; 
      transition: background-color 0.2s; 
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.4);
      margin-top: 1rem;
      font-size: 1rem;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #btn-translate:hover:not(:disabled) { background-color: var(--primary-dark); }
    #btn-translate:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    /* --- Status & Loading --- */
    #status { 
      display: none; /* Hidden as per original setup */
    }

    #status-display { 
      margin-top: 1rem; padding: 0.5rem 1rem; background: #fff3e0; border: 1px solid #ffcc80; 
      border-radius: 0.375rem; font-size: 0.875rem; color: #a55a00; font-weight: 500; 
      white-space: pre-wrap;
    }

    /* === JSON Output Styling (VS Code Dark Theme Look) === */
    pre {
      background-color: #f6f8fa;
      color: #24292e;
      font-family: Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 14px;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #d0d7de;
      display: block;
      overflow-x: auto;
      line-height: 1.5;

      margin: 0;
      max-height: 400px;
    }

    #result {
      background-color: #f6f8fa;
      color: #24292e;
      font-family: Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 14px;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #d0d7de;
      display: block;
      overflow-x: auto;
      line-height: 1.5; 
      word-wrap: break-word;
      margin-top: 0.5rem;
    }

    #messages {
      background-color: #f6f8fa;
      color: #24292e;
      font-family: Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 14px;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #d0d7de;
      display: block;
      overflow-x: auto;
      line-height: 1.5; 
      margin: 0;
      padding: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Custom Syntax Highlighting (VS Code Style) */
    .hljs-attr { color: #9cdcfe !important; }      /* Keys: Light Blue */
    .hljs-string { color: #ce9178 !important; }    /* Strings: Orange/Salmon */
    .hljs-number { color: #b5cea8 !important; }    /* Numbers: Light Green */
    .hljs-literal, .hljs-keyword { color: #569cd6 !important; } /* Booleans: Blue */
    .hljs-punctuation { color: #d4d4d4 !important; } /* Punctuation: Light Gray */
    
    /* --- LOADING OVERLAY STYLES (Fixed and Centered) --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      z-index: 1000;
      display: flex; 
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 0.5s ease;
      opacity: 1;
    }
    .loader {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    #loading-text {
      font-size: 1.1rem;
      color: var(--text-main);
      font-weight: 500;
      text-align: center;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .json-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 20; }
    .json-btn { background: transparent !important; border: none !important; border-radius: 4px; color: #d4d4d4; padding: 0px 4px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; backdrop-filter: none; }
    .json-btn:hover { background: rgba(255, 255, 255, 0.1) !important; color: #ffffff; }
    .json-btn.copied { color: #4CAF50 !important; }

    /* Headings */
    #result-title, #messages-title {
      margin-top: 1.5rem;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="loader"></div>
    <div id="loading-text">Initializing search-query...</div>
  </div>
  
  <div id="content-wrapper">
    <header>
      <h1>search-query translator</h1>
      <p>Translate a database/search-platform query into another platform using the <code>search-query</code> package (running in Pyodide).</p>
    </header>

    <div id="status">Loading Pyodide…</div>
    <div id="status-display">Loading Search Query…</div>

    <label for="query">Query</label>
    <textarea id="query" rows="6">(TI=(platform* OR "digital work") AND PY=2020-2025)</textarea>

    <label for="platform-source">Source platform</label>
    <select id="platform-source">
      <option value="wos">wos</option>
      <option value="pubmed">pubmed</option>
      <option value="ebscohost">ebscohost</option>
      <option value="scopus">scopus</option>
    </select>

    <label for="platform-target">Target platform</label>
    <select id="platform-target">
      <option value="wos">wos</option>
      <option value="pubmed" selected>pubmed</option>
      <option value="ebscohost">ebscohost</option>
      <option value="scopus">scopus</option>
    </select>

    <div class="row" style="margin-top:1rem;">
      <button id="btn-translate" disabled>Translate</button>
    </div>

    <h2 id="result-title" style="display:none; margin-top:1.5rem;">Translated query</h2>
    <div style="position: relative;">
        <div class="json-actions" id="json-actions" style="display:none;">
            <button class="json-btn" id="copy-json" title="Copy JSON">
                <i class="far fa-copy"></i>
            </button>
            <button class="json-btn" id="download-json" title="Download JSON">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <pre id="result" style="display:none;"></pre>
    </div>


    <h2 id="messages-title" style="display:none; margin-top:1.5rem;">Messages</h2>
    <div id="messages" style="display:none;"></div>
  </div>

  <!-- Pyodide runtime -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
  
  <script>
    // Add this at the beginning of your script
    const isEmbedded = window.parent !== window;
    
    // Initialize Highlight.js
    hljs.configure({ ignoreUnescapedHTML: true });

    const loader = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const contentWrapper = document.getElementById('content-wrapper');
    const statusDisplay = document.getElementById('status-display');
    const btnTranslate = document.getElementById('btn-translate');
    const codeBlock = document.getElementById('result');
    
    // Function to update JSON output with highlighting
    function updateJsonOutput(jsonData) {
      const codeElement = document.getElementById('messages').querySelector('code');
      
      // 1. Convert to Pretty String
      const formattedJson = JSON.stringify(jsonData, null, 2);
      
      // 2. Set text content
      codeElement.textContent = formattedJson;
      
      // 3. Clear markers
      codeElement.removeAttribute('data-highlighted');
      
      // 4. Trigger Highlight.js
      hljs.highlightElement(codeElement);
      
      console.log('JSON output highlighted with VS Code theme');
    }
    
    function copyJsonToClipboard() {
      const jsonText = codeBlock.textContent; 
      navigator.clipboard.writeText(jsonText).then(() => {
          const copyBtn = document.getElementById('copy-json');
          const originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check"></i>';
          copyBtn.classList.add('copied');
          setTimeout(() => {
              copyBtn.innerHTML = originalHTML;
              copyBtn.classList.remove('copied');
          }, 2000);
      });
    }

    function downloadJson() {
      const jsonText = codeBlock.textContent;
      const blob = new Blob([jsonText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'linter-output.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Debounce to prevent excessive height updates
    let heightTimeout;
    function debouncedSendHeight() {
        clearTimeout(heightTimeout);
        heightTimeout = setTimeout(sendHeight, 150);
    }

    // CORRECTED sendHeight function - measures the LAST VISIBLE ELEMENT's bottom position
    function sendHeight() {
        // Only adjust iframe if we're embedded
        if (!isEmbedded) {
            document.body.style.overflowY = 'auto';
            document.body.style.overflowX = 'auto';
            return;
        }
        
        // Hide scrollbars when embedded
        document.body.style.overflow = 'hidden';
        
        // Don't calculate during loading
        if (loader.style.display !== 'none') return;
        
        // Get ALL elements inside content-wrapper
        const wrapper = document.getElementById('content-wrapper');
        if (!wrapper) return;
        
        const allElements = wrapper.getElementsByTagName('*');
        let lastVisibleElement = null;
        let maxBottom = 0;
        
        // Find the element with the highest bottom position (last visible element)
        for (let element of allElements) {
            const style = window.getComputedStyle(element);
            
            // Skip hidden elements
            if (style.display === 'none' || style.visibility === 'hidden') {
                continue;
            }
            
            // Get element's position
            const rect = element.getBoundingClientRect();
            
            // Only consider elements that are actually in the view (have height)
            if (rect.height > 0) {
                const elementBottom = rect.bottom + window.pageYOffset;
                
                // Track the element with the highest bottom position
                if (elementBottom > maxBottom) {
                    maxBottom = elementBottom;
                    lastVisibleElement = element;
                }
            }
        }
        
        // If no elements found, use the wrapper itself
        if (!lastVisibleElement) {
            lastVisibleElement = wrapper;
            const rect = wrapper.getBoundingClientRect();
            maxBottom = rect.bottom + window.pageYOffset;
        }
        
        // Get the top of the document
        const docTop = document.documentElement.getBoundingClientRect().top + window.pageYOffset;
        
        // Calculate height: from top of document to bottom of last visible element
        const contentHeight = maxBottom - docTop;
        
        // Add a small buffer (20px) to prevent cut-off
        const finalHeight = contentHeight + 20;
        
        console.log('Last element:', lastVisibleElement.tagName, 
                   'Bottom position:', maxBottom, 
                   'Calculated height:', Math.ceil(finalHeight));
        
        // Send to parent frame
        window.parent.postMessage(
            { type: 'setHeight', height: Math.ceil(finalHeight) },
            '*'
        );
    }
    
    // Listen for resize events
    window.addEventListener('resize', debouncedSendHeight);
  
    const originalAppendStatus = window.appendStatus || function(msg) { 
      const statusDiv = document.getElementById('status');
      if (statusDiv) {
        statusDiv.textContent = msg; 
      }
      console.log("Pyodide Hook:", msg); 
    };
    
    window.appendStatus = function(msg) {
      // 1. Update the visual status text in status-display
      const cleanMsg = msg.replace(/\u001b\[.*?m/g, ''); 
      if (loadingText) loadingText.textContent = cleanMsg;
      statusDisplay.textContent = cleanMsg;

      if (cleanMsg.includes('Done') || cleanMsg.includes('ready') || cleanMsg.includes('Ready')) {
          // Done loading
          statusDisplay.innerText = 'Search Query loaded…';
          loader.style.opacity = '0';
          contentWrapper.style.opacity = '1';
      
          setTimeout(() => {
            loader.style.display = 'none';
            
            // CRITICAL: Only lock overflow if embedded
            if (isEmbedded) {
              document.body.style.overflow = 'hidden';
            } else {
              document.body.style.overflow = 'auto';
            }
            
            btnTranslate.disabled = false;
            debouncedSendHeight(); // Use debounced version
          }, 500);
      }
      
      // Call the original function
      originalAppendStatus(msg);
      
      // Trigger height check
      debouncedSendHeight();
    };
    
    // --- Append module with interval stopped after ready ---
    const appendInterval = setInterval(() => {
      const statusText = document.getElementById('status');
      const lines = statusText.innerText.split("\n");
      const lastLine = lines[lines.length - 1].trim();

      loadingText.innerText = lastLine || "Loading…";
      statusDisplay.innerText = lastLine || "Loading…";

      if (lastLine.includes("search-query ready.")) {
        loader.style.display = 'none';
        contentWrapper.style.display = 'block';
        contentWrapper.style.opacity = '1';
        statusText.innerText = 'Search Query Ready';
        statusDisplay.innerText = 'Search Query Ready';
        
        // Enable the translate button
        btnTranslate.disabled = false;
        
        // Stop the interval to prevent unnecessary height updates
        clearInterval(appendInterval);

        // Send final height once
        debouncedSendHeight();
      }
    }, 100);

    // --- Initial Setup and DOM Observer ---
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial overflow based on whether embedded
      if (isEmbedded) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = 'auto';
      }
      
      // When translate button is clicked
      btnTranslate.addEventListener('click', () => {
          // Wait for results to render, then update height
          setTimeout(debouncedSendHeight, 800);
      });
      
      // Initial state setup
      document.body.classList.add('loading-active');
      contentWrapper.style.opacity = '0';
      contentWrapper.style.display = 'none';
      loader.style.display = 'flex';
      document.getElementById('copy-json').addEventListener('click', copyJsonToClipboard);
      document.getElementById('download-json').addEventListener('click', downloadJson);
      loadingText.textContent = "Initializing search-query...";
      btnTranslate.disabled = true;

      // Initialize Highlight.js
      hljs.highlightAll();

      // Send initial minimal height
      window.addEventListener('load', debouncedSendHeight);
      
      // Observe DOM changes
      const observer = new MutationObserver(debouncedSendHeight);
      observer.observe(document.body, { 
          childList: true, 
          subtree: true,
          attributes: true 
      });
    });

  </script>
  
  <script src="search_query_pkg_tree.js"></script>
  <script src="translate.js"></script>
</body>
</html>
