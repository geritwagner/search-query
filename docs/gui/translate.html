<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>search-query translator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Highlight.js for JSON coloring -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  
  <style>
    /* --- CSS Variables (Ensure consistency with Host) --- */
    :root {
      --primary: #4f46e5;       /* Indigo */
      --primary-dark: #3f35c5;
      --bg-card: #ffffff;
      --border-color: #e5e7eb;  /* Gray-200 */
      --text-main: #1f2937;     /* Dark Gray */
      --text-secondary: #6b7280; /* Medium Gray */
    }

    /* --- Global Resets & Body Styles for IFRAME --- */
    * { box-sizing: border-box; margin: 0; padding: 0; line-height: 1.5; font-family: 'Inter', sans-serif; }
    
    body {
      background-color: var(--bg-card);
      color: var(--text-main);
      padding: 1.5rem; 
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: hidden;
      position: relative;
    }

    /* UTILITY CLASS FOR VIEWPORT LOCK */
    body.loading-active {
      overflow: hidden; /* Prevents scrolling */
      height: 100vh;    /* Locks height */
    }
    
    /* --- Layout & Typography --- */
    header h1 { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem; }
    header p { color: var(--text-secondary); margin-top: 0; font-size: 0.95rem; }
    
    /* --- Form Elements --- */
    label { display: block; margin-top: 1.25rem; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.875rem; }
    
    /* Query textarea with larger font size */
    #query {
      font-size: 1.1rem !important;
      line-height: 1.6;
      padding: 1rem;
      min-height: 120px;
      font-family: 'Courier New', monospace;
      width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.07);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    #query:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary);
      outline: none;
    }
    
    /* Narrower form elements */
    select { 
      display: block; width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); 
      border-radius: 0.5rem; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.07); 
      transition: border-color 0.2s, box-shadow 0.2s; color: var(--text-main);
      max-width: 300px;
    }
    
    select:focus { 
      border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); outline: none; 
    }

    /* --- Button --- */
    #btn-translate {
      width: auto; /* Make button narrower */
      min-width: 200px; /* Minimum width */
      padding: 0.75rem 2rem; /* Narrower padding */
      border: none; 
      border-radius: 0.5rem; 
      font-weight: 600; 
      color: white; 
      background-color: var(--primary); 
      cursor: pointer; 
      transition: background-color 0.2s; 
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.4);
      margin-top: 1rem;
      font-size: 1rem;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #btn-translate:hover:not(:disabled) { background-color: var(--primary-dark); }
    #btn-translate:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    /* --- Status & Loading --- */
    #status { 
      display: none; /* Hidden as per original setup */
    }

    #status-display { 
      margin-top: 1rem; padding: 0.5rem 1rem; background: #fff3e0; border: 1px solid #ffcc80; 
      border-radius: 0.375rem; font-size: 0.875rem; color: #a55a00; font-weight: 500; 
      white-space: pre-wrap;
    }

    /* === JSON Output Styling (VS Code Dark Theme Look) === */
    pre {
      background-color: #1e2228 !important; /* VS Code Dark Background */
      border: 1px solid #333;
      border-radius: 0.5rem;
      margin: 0;
      padding: 1rem;
      max-height: 400px;
      overflow: auto;
      color: #d4d4d4; /* Default Text Color */
    }

    #result {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
      background:  #1e2228;;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 0.5rem;
    }

    #messages {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
      background: #1e2228 !important;
      margin: 0;
      padding: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Custom Syntax Highlighting (VS Code Style) */
    .hljs-attr { color: #9cdcfe !important; }      /* Keys: Light Blue */
    .hljs-string { color: #ce9178 !important; }    /* Strings: Orange/Salmon */
    .hljs-number { color: #b5cea8 !important; }    /* Numbers: Light Green */
    .hljs-literal, .hljs-keyword { color: #569cd6 !important; } /* Booleans: Blue */
    .hljs-punctuation { color: #d4d4d4 !important; } /* Punctuation: Light Gray */
    
    /* --- LOADING OVERLAY STYLES (Fixed and Centered) --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      z-index: 1000;
      display: flex; 
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: opacity 0.5s ease;
      opacity: 1;
    }
    .loader {
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    #loading-text {
      font-size: 1.1rem;
      color: var(--text-main);
      font-weight: 500;
      text-align: center;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .json-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 20; }
    .json-btn { background: transparent !important; border: none !important; border-radius: 4px; color: #d4d4d4; padding: 6px 8px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; backdrop-filter: none; }
    .json-btn:hover { background: rgba(255, 255, 255, 0.1) !important; color: #ffffff; }
    .json-btn.copied { color: #4CAF50 !important; }

    /* Headings */
    #result-title, #messages-title {
      margin-top: 1.5rem;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="loader"></div>
    <div id="loading-text">Initializing search-query...</div>
  </div>
  
  <div id="content-wrapper">
    <header>
      <h1>search-query translator</h1>
      <p>Translate a database/search-platform query into another platform using the <code>search-query</code> package (running in Pyodide).</p>
    </header>

    <div id="status">Loading Pyodide…</div>
    <div id="status-display">Loading Search Query…</div>

    <label for="query">Query</label>
    <textarea id="query" rows="6">(TI=(platform* OR "digital work") AND PY=2020-2025)</textarea>

    <label for="platform-source">Source platform</label>
    <select id="platform-source">
      <option value="wos">wos</option>
      <option value="pubmed">pubmed</option>
      <option value="ebscohost">ebscohost</option>
      <option value="scopus">scopus</option>
    </select>

    <label for="platform-target">Target platform</label>
    <select id="platform-target">
      <option value="wos">wos</option>
      <option value="pubmed" selected>pubmed</option>
      <option value="ebscohost">ebscohost</option>
      <option value="scopus">scopus</option>
    </select>

    <div class="row" style="margin-top:1rem;">
      <button id="btn-translate" disabled>Translate</button>
    </div>

    <h2 id="result-title" style="display:none; margin-top:1.5rem;">Translated query</h2>
    <div style="position: relative;">
        <div class="json-actions">
            <button class="json-btn" id="copy-json" title="Copy JSON">
                <i class="far fa-copy"></i>
            </button>
            <button class="json-btn" id="download-json" title="Download JSON">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <pre id="result" style="display:none;"></pre>
    </div>


    <h2 id="messages-title" style="display:none; margin-top:1.5rem;">Messages</h2>
    <div id="messages" style="display:none;"></div>
  </div>

  <!-- Pyodide runtime -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
  
  <script>
    // Initialize Highlight.js
    hljs.configure({ ignoreUnescapedHTML: true });

    const loader = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');
    const contentWrapper = document.getElementById('content-wrapper');
    const statusDisplay = document.getElementById('status-display'); // Now using status-display
    const btnTranslate = document.getElementById('btn-translate');
    const codeBlock = document.getElementById('result');
    // Function to update JSON output with highlighting
    function updateJsonOutput(jsonData) {
      const codeElement = document.getElementById('messages').querySelector('code');
      
      // 1. Convert to Pretty String
      const formattedJson = JSON.stringify(jsonData, null, 2);
      
      // 2. Set text content
      codeElement.textContent = formattedJson;
      
      // 3. Clear markers
      codeElement.removeAttribute('data-highlighted');
      
      // 4. Trigger Highlight.js
      hljs.highlightElement(codeElement);
      
      console.log('JSON output highlighted with VS Code theme');
    }
    function copyJsonToClipboard() {
      const jsonText = codeBlock.textContent; 
      navigator.clipboard.writeText(jsonText).then(() => {
          const copyBtn = document.getElementById('copy-json');
          const originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = '<i class="fas fa-check"></i>';
          copyBtn.classList.add('copied');
          setTimeout(() => {
              copyBtn.innerHTML = originalHTML;
              copyBtn.classList.remove('copied');
          }, 2000);
      });
  }

  function downloadJson() {
      const jsonText = codeBlock.textContent;
      const blob = new Blob([jsonText], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'linter-output.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
  }

    // --- Cross-Origin Height Communication ---
    function sendHeight() {
      // Only send height if the loader is not active (i.e., content is visible)
      if (loader.style.display !== 'none') return;

      const height = document.body.scrollHeight;
      if (window.parent) {
        window.parent.postMessage({
          type: 'setHeight',
          height: height
        }, window.location.origin);
      }
    }
    
    // --- Pyodide Status Hook and Loader Control ---
    
    const originalAppendStatus = window.appendStatus || function(msg) { 
      const statusDiv = document.getElementById('status');
      if (statusDiv) {
        // If Pyodide outputs complex status (which includes ANSI codes), write to hidden div
        statusDiv.textContent = msg; 
      }
      console.log("Pyodide Hook:", msg); 
    };
    
    window.appendStatus = function(msg) {
      // 1. Update the visual status text in status-display
      const cleanMsg = msg.replace(/\u001b\[.*?m/g, ''); 
      if (loadingText) loadingText.textContent = cleanMsg;
      statusDisplay.textContent = cleanMsg;

      // 2. Control the visual transition state and viewport lock
      if (cleanMsg.includes('Done') || cleanMsg.includes('ready') || cleanMsg.includes('Ready')) {
        // Done loading: Unlock viewport, fade out loader, show content
        document.body.classList.remove('loading-active');
        statusDisplay.innerText = 'Search Query loaded…';
        loader.style.opacity = '0';
        contentWrapper.style.opacity = '1';

        setTimeout(() => {
          loader.style.display = 'none';
          document.body.style.overflow = 'hidden'; 
          btnTranslate.disabled = false;
          sendHeight(); // Final resize
        }, 500);
      } else {
        // Loading: Lock viewport
        document.body.classList.add('loading-active');
        loader.style.display = 'flex';
        loader.style.opacity = '1';
        contentWrapper.style.opacity = '0';
      }

      // 3. Call the original function and re-trigger height update 
      originalAppendStatus(msg);
      setTimeout(sendHeight, 50); 
    };
    
    // --- Append module with interval stopped after ready ---
    const appendInterval = setInterval(() => {
      const statusText = document.getElementById('status');
      const lines = statusText.innerText.split("\n");
      const lastLine = lines[lines.length - 1].trim();

      loadingText.innerText = lastLine || "Loading…";
      statusDisplay.innerText = lastLine || "Loading…";

      if (lastLine.includes("search-query ready.")) {
        loader.style.display = 'none';
        contentWrapper.style.display = 'block';
        contentWrapper.style.opacity = '1';
        statusText.innerText = 'Search Query Ready';
        statusDisplay.innerText = 'Search Query Ready';
        
        // Enable the translate button
        btnTranslate.disabled = false;
        
        // Stop the interval to prevent unnecessary height updates
        clearInterval(appendInterval);

        // Send final height once
        sendHeight();
      }
    }, 100);

    // --- Initial Setup and DOM Observer ---
    document.addEventListener('DOMContentLoaded', () => {
      // Initial state setup: LOCK VIEWPORT IMMEDIATELY
      document.body.classList.add('loading-active');
      contentWrapper.style.opacity = '0';
      contentWrapper.style.display = 'none';
      loader.style.display = 'flex';
      document.getElementById('copy-json').addEventListener('click', copyJsonToClipboard);
      document.getElementById('download-json').addEventListener('click', downloadJson);
      loadingText.textContent = "Initializing search-query...";
      btnTranslate.disabled = true;

      // Initialize Highlight.js
      hljs.highlightAll();

      // 1. Send initial minimal height
      window.addEventListener('load', sendHeight);
      
      // 2. Observe DOM changes (Crucial for when the output table appears/disappears)
      const observer = new MutationObserver(sendHeight);
      observer.observe(document.body, { attributes: true, childList: true, subtree: true });
    });

  </script>
  
  <!-- your logic (the file I gave you) -->
  <script src="translate.js"></script>
</body>
</html>
